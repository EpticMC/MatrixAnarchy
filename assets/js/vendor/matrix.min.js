/**
 * MatrixJS
 * Copyright (c) NullDev
 * https://github.com/NLDev/matrixjs
 */
var fontSize,textX,textY,currentTime,context,timer,mapW,mapH,maxPause,maxDropRdmArg,maxDropsINColumn,refreshDelay,completedFromLeft,minWidth,minHeight,windowWidth,windowHeight,canvas,letters="アイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤユ42ヨラリルレロワヰヱヲンㄅㄆㄇㄈㄉㄊㄋㄌㄍㄎㄏㄐㄒㄓㄔㄕㄗㄘㄙㄚㄛㄜㄝㄞㄠㄡㄢㄣㄤㄥㄦㄨㄩㄪㄫㄬ",chrSetPow=letters.length,matrixMap=[],charText=["","","","",""],mDropsCount="mDropsCount",mActive="mActive",mType="mType",mPauseValue="mPauseValue",mCurrentPause="mCurrentPause",mGreen="mGreen",mWhite="mWhite",mSymbol="mSymbol",mText="mText",mTextActive="mTextActive",mColumnUsed="mColumnUsed",mColumnUsedCount="mColumnUsedCount",mFade="mFade";function get_random_int(a,t){return Math.floor(Math.random()*(t-a+1))+a}function get_random_spawn_x(){var a=get_random_int(0,mapW);if(1!=maxDropsINColumn&&matrixMap[a][mActive]&&1==get_random_int(0,2))for(var t=completedFromLeft;t<=mapW;++t)if(!matrixMap[t][mActive]){completedFromLeft=a=t;break}return a}function get_random_char(){var a=get_random_int(0,chrSetPow-1);return letters.slice(a,a+1)}function config_second_phase(){maxDropRdmArg=5,maxDropsINColumn=1,refreshDelay=33}function spawn_new_drop(){for(var a=get_random_spawn_x(),t=0;10!=t&&matrixMap[a][mDropsCount]>=maxDropsINColumn;++t)a=get_random_int(0,mapW);matrixMap[a][mDropsCount]<maxDropsINColumn&&(matrixMap[a][0][mType]=1,matrixMap[a][0][mPauseValue]=get_random_int(0,maxPause),matrixMap[a][0][mCurrentPause]=matrixMap[a][0][mPauseValue],matrixMap[a][0][mWhite]=250,matrixMap[a][0][mGreen]=0,matrixMap[a][0][mSymbol]=get_random_char(),matrixMap[a][0][mFade]=get_random_int(5,10),matrixMap[a][mDropsCount]++,matrixMap[a][mActive]=!0,matrixMap[a][mColumnUsed]||(matrixMap[a][mColumnUsed]=!0,matrixMap[mColumnUsedCount]++,matrixMap[mColumnUsedCount]>=mapW+1&&config_second_phase()))}function update(){for(var a=0;a<=mapW;++a)if(matrixMap[a][mActive]){for(var t=!1,e=0;e<=mapH;++e)if(0!=matrixMap[a][e][mType]){if(t=!0,0<matrixMap[a][e][mCurrentPause]){matrixMap[a][e][mCurrentPause]--;continue}switch(matrixMap[a][e][mCurrentPause]=matrixMap[a][e][mPauseValue],matrixMap[a][e][mType]){case 1:if(e<mapH&&!(matrixMap[a][e][mTextActive]&&" "!=matrixMap[a][e][mText]&&0<matrixMap[a][e][mText].length))for(var m in matrixMap[a][e])"mText"!=m&&"mTextActive"!=m&&(matrixMap[a][e+1][m]=matrixMap[a][e][m]);else matrixMap[a][mDropsCount]--;matrixMap[a][e][mSymbol]=get_random_char(),matrixMap[a][e][mType]=2,matrixMap[a][e][mCurrentPause]=matrixMap[a][e][mPauseValue],matrixMap[a][e][mWhite]=200,matrixMap[a][e][mGreen]=0,matrixMap[a][e][mTextActive]=!0,e<mapH&&e++;break;case 2:42==get_random_int(1,100)&&(matrixMap[a][e][mSymbol]=get_random_char()),150<matrixMap[a][e][mWhite]?(matrixMap[a][e][mWhite]-=50,matrixMap[a][e][mWhite]<=150&&(matrixMap[a][e][mWhite]=0,matrixMap[a][e][mGreen]=250)):0<matrixMap[a][e][mGreen]&&(matrixMap[a][e][mGreen]-=matrixMap[a][e][mFade],matrixMap[a][e][mGreen]<=0&&(matrixMap[a][e][mGreen]=0,matrixMap[a][e][mType]=0))}}t||(matrixMap[a][mActive]=!1)}1==get_random_int(1,maxDropRdmArg)&&spawn_new_drop()}function draw(){var a,t;for(context.fillStyle="black",context.fillRect(0,0,canvasW,canvasH),context.font="bold "+fontSize+"px monaco, consolas, courier, monospace",a=0;a<=mapW;++a)if(matrixMap[a][mActive])for(t=0;t<=mapH;++t)0!=matrixMap[a][t][mType]&&(context.fillStyle="rgb("+matrixMap[a][t][mWhite]+", "+Math.max(matrixMap[a][t][mGreen],matrixMap[a][t][mWhite])+", "+matrixMap[a][t][mWhite]+")",matrixMap[a][t][mTextActive]&&" "!=matrixMap[a][t][mText]&&0!=matrixMap[a][t][mText].length||context.fillText(matrixMap[a][t][mSymbol],a*fontSize,t*fontSize))}function launch(){clearInterval(timer);var a=currentTime.getMilliseconds();update(),draw(),timer=setInterval(launch,refreshDelay-(currentTime.getMilliseconds()-a))}function init(){clearInterval(timer),currentTime=new Date,fontSize=14+Math.max(parseInt((document.body.offsetWidth-1200)/100),0),minWidth=charText[0].length*fontSize,minHeight=charText.length*fontSize,windowWidth=Math.max(document.body.offsetWidth,minWidth),windowHeight=Math.max(document.body.offsetHeight,minHeight),document.body.style.minWidth=minWidth,document.body.style.minHeight=minHeight,(canvas=document.getElementById("mainCanvas")).width=windowWidth,canvas.height=windowHeight,canvasW=canvas.width,canvasH=canvas.height,context=canvas.getContext("2d"),mapW=parseInt(canvasW/fontSize),mapH=parseInt(canvasH/fontSize),maxDropRdmArg=maxPause=1,maxDropsINColumn=2,refreshDelay=25,completedFromLeft=0,timer=setInterval(launch,refreshDelay),textX=parseInt((mapW-charText[0].length)/2),textY=parseInt((mapH-charText.length)/2);for(var a=matrixMap[mColumnUsedCount]=0;a<=mapW;++a){matrixMap[a]=[],matrixMap[a][mDropsCount]=0,matrixMap[a][mColumnUsed]=!1,matrixMap[a][mActive]=!1;for(var t=0;t<=mapH;++t)matrixMap[a][t]=[],matrixMap[a][t][mType]=0,matrixMap[a][t][mPauseValue]=0,matrixMap[a][t][mCurrentPause]=0,matrixMap[a][t][mGreen]=0,matrixMap[a][t][mWhite]=0,matrixMap[a][t][mSymbol]="",matrixMap[a][t][mFade]=0,matrixMap[a][t][mText]="",matrixMap[a][t][mTextActive]=!1}for(var a=0,e=textX;a!=charText[0].length;++a,++e)for(var t=0,m=textY;t!=charText.length;++t,++m)matrixMap[e][m][mText]=charText[t][a]}
